# name: CI branches
# this pipeline validates and generate the builds for master or develop branch
trigger:
  batch: true
  branches:
    include:
      - master
      - develop
  paths:
    exclude:
      - .azure-pipelines/*
      - .vscode/*
      - docs/*
      - tools/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/master') }}:
    ENV: 'prod'
  ${{ if ne(variables['Build.SourceBranch'], 'refs/heads/master') }}:
    ENV: 'dev'

jobs:
  - job: initial_setup
    displayName: nx calculate commandas
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: |
          echo "##vso[task.setvariable variable=COMMANDS;isOutput=true]$(node ./tools/scripts/nx-calculate-commands.js false)"
        name: setCommands
      - script: echo $(setCommands.COMMANDS)
        name: echoCommands

  - job: lint
    displayName: lint projects
    dependsOn: initial_setup
    condition: |
      and(
        succeeded(),
        not(
          contains(
            dependencies.initial_setup.outputs['setCommands.COMMANDS'],
            '"lint":[]'
          )
        )
      )
    variables:
      COMMANDS: $[ dependencies.initial_setup.outputs['setCommands.COMMANDS'] ]
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: node ./tools/scripts/nx-run-many.js '$(COMMANDS)' lint
        displayName: running lint

  - job: test
    displayName: test projects
    dependsOn: initial_setup
    condition: |
      and(
        succeeded(),
        not(
          contains(
            dependencies.initial_setup.outputs['setCommands.COMMANDS'],
            '"test":[]'
          )
        )
      )
    variables:
      COMMANDS: $[ dependencies.initial_setup.outputs['setCommands.COMMANDS'] ]
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: node ./tools/scripts/nx-run-many.js '$(COMMANDS)' test
        displayName: running tests

  - job: build
    displayName: build projects
    dependsOn: initial_setup
    condition: |
      and(
        succeeded(),
        not(
          contains(
            dependencies.initial_setup.outputs['setCommands.COMMANDS'],
            '"build":[]'
          )
        )
      )
    variables:
      COMMANDS: $[ dependencies.initial_setup.outputs['setCommands.COMMANDS'] ]
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: node ./tools/scripts/nx-run-many.js '$(COMMANDS)' build $(ENV)
        displayName: running builds
