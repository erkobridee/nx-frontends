trigger:
  batch: true
  branches:
    include:
      - master
      - develop
  paths:
    exclude:
      - .azure-pipelines/*
      - .vscode/*
      - docs/*
      - tools/*

pr:
  - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  IS_PULL_REQUEST: $[ eq(variables['Build.Reason'], 'PullRequest') ]
  ${{ if eq(variables['Build.SourceBranch'], 'refs/heads/master') }}:
    ENV: 'production'
  ${{ if ne(variables['Build.SourceBranch'], 'refs/heads/master') }}:
    ENV: 'development'

jobs:
  - job: initial_setup
    displayName: nx calculate commandas
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: |
          echo "##vso[task.setvariable variable=COMMANDS;isOutput=true]$(node ./tools/scripts/nx-calculate-commands.js $(IS_PULL_REQUEST))"
        name: setCommands
      - script: echo $(setCommands.COMMANDS)
        name: echoCommands

  - job: lint
    displayName: lint projects
    dependsOn: initial_setup
    condition: |
      and(
        succeeded(),
        not(
          contains(
            dependencies.initial_setup.outputs['setCommands.COMMANDS'],
            '"lint":[]'
          )
        )
      )
    variables:
      COMMANDS: $[ dependencies.initial_setup.outputs['setCommands.COMMANDS'] ]
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: node ./tools/scripts/nx-run-many.js '$(COMMANDS) lint $(ENV)'

  - job: test
    displayName: test projects
    dependsOn: initial_setup
    condition: |
      and(
        succeeded(),
        not(
          contains(
            dependencies.initial_setup.outputs['setCommands.COMMANDS'],
            '"test":[]'
          )
        )
      )
    variables:
      COMMANDS: $[ dependencies.initial_setup.outputs['setCommands.COMMANDS'] ]
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: node ./tools/scripts/nx-run-many.js '$(COMMANDS) test $(ENV)'

  - job: build
    displayName: build projects
    dependsOn: initial_setup
    condition: |
      and(
        succeeded(),
        not(
          contains(
            dependencies.initial_setup.outputs['setCommands.COMMANDS'],
            '"build":[]'
          )
        )
      )
    variables:
      COMMANDS: $[ dependencies.initial_setup.outputs['setCommands.COMMANDS'] ]
    steps:
      - template: templates/steps_install-node-modules.yml
      - script: node ./tools/scripts/nx-run-many.js '$(COMMANDS) build $(ENV)'