# Quickstart: Install extensions
# https://docs.microsoft.com/en-us/azure/devops/marketplace/install-extension?view=azure-devops&tabs=browser
#
# marketplace
# https://marketplace.visualstudio.com/items?itemName=1ESLighthouseEng.PipelineArtifactCaching
#
# source code
# https://github.com/microsoft/azure-pipelines-artifact-caching-tasks
#
# need to have the artifacts enabled on the project and create one
# with the vtstsFeed name bellow
#
# steps:
#   - task: 1ESLighthouseEng.PipelineArtifactCaching.RestoreAndSaveCacheV1.RestoreAndSaveCache@1
#     inputs:
#       keyfile: '**/package-lock.json'
#       targetfolder: '**/node_modules, !**/node_modules/**/node_modules'
#       vstsFeed: $(ArtifactFeed)

#   - script: |
#       npm i
#     displayName: Install dependencies only if there is no cache available
#     condition: ne(variables['CacheRestored'], 'true')

steps:
  - script: npm ci
    condition: ne(variables.CACHE_RESTORED, 'true')
    displayName: Install dependencies only if there is no cache available

  - task: Cache@2
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
        npm
      path: node_modules
      cacheHitVar: CACHE_RESTORED
    displayName: Cache node_modules
