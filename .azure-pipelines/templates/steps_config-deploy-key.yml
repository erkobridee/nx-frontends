# based on:
# Publishing GitHub Pages from Azure Pipelines
# https://cloudblogs.microsoft.com/opensource/2019/04/05/publishing-github-pages-from-azure-pipelines/
#
# Download Secure File task
# https://docs.microsoft.com/en-us/azure/devops/pipelines/tasks/utility/download-secure-file
#
steps:
  - task: DownloadSecureFile@1
    name: deployKey
    inputs:
      secureFile: deploy_key
    displayName: 'Get the deploy key'

  - task: DownloadSecureFile@1
    name: deployPass
    inputs:
      secureFile: deploy_pass
    displayName: 'Get the deploy pass'

  - script: |
      echo 'Installing deployment key'
      mkdir ~/.ssh
      chmod 700 ~/.ssh

      mv $(deployKey.secureFilePath) ~/.ssh/deploy_key
      chmod 600 ~/.ssh/deploy_key

      mv $(deployPass.secureFilePath) ~/.ssh/deploy_pass
      chmod 600 ~/.ssh/deploy_pass

      echo 'add the deployment key to the ssh'
      chmod +x tools/scripts/ssh-add-pass.sh
      tools/scripts/ssh-add-pass.sh ~/.ssh/deploy_key ~/.ssh/deploy_pass

      echo 'check github authentication'
      ssh -T git@github.com

      echo 'ssh-keyscan'
      ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
    displayName: 'Configure to use the deploy key'
